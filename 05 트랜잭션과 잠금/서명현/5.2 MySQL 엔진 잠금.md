## 2. MySQL 엔진 잠금

MySQL에서 사용되는 잠금은 크게 2가지로 나뉜다.

- MySQL 엔진 레벨
- 스토리지 엔진 레벨

MySQL 엔진 레벨의 잠금은 스토리지 엔진에 영향을 미치지만, 스토리지 엔진 레벨의 잠금은 스토리지 엔진 간의 상호 영향을 미치지 않는다. 

MySQL 엔진 레벨의 잠금의 종류를 살펴보겠다.

### 글로벌 락

MySQL에서 제공하는 잠금 중 범위가 가장 크다. 한 세션에서 글로벌 락을 획득하면 다른 세션에서 select를 제외한 대부분의 DDL, DML 문장은 대기한다.
글로벌 락이 해제될 때까지 기다려야 한다. 이는 MySQL 서버 전체에 영향을 미치며, 테이블이나 데이터베이스가 다르더라도 동일하게 영향을 미친다.

MyISAM, Memory 테이블에 대해 mysqldump로 일관된 백업을 받아야할 때 사용한다.
InnoDB에서는 트랜잭션을 지원하기 때문에 모든 데이터 작업을 멈추진 않아도 된다. 그래서 MySQL 8.0부터 더 가벼운 락의 필요성이 생겨 백업 툴들의 안정적인 실행을 위해 백업 락이 도입됐다.

![스크린샷 2023-12-01 171952](https://github.com/sa46lll/real-mysql/assets/62706048/a21fd6e2-39cc-436f-82db-b9595557b0fb)

### 테이블 락

테이블 락은 개별 테이블 단위로 락을 걸 수 있다. 테이블 락은 MySQL 서버 전체에 영향을 미치지 않으며, MyISAM 뿐만 아니라 InnoDB 스토리지 엔진을 사용하는 테이블도 설정할 수 있다.
명시적, 묵시적으로 락을 획득할 수 있으며, 명시적인 테이블 락은 특별한 상황 외의 애플리케이션에서는 거의 사용할 필요가 없다.
명시적으로 테이블을 잠그면, 글로벌 락과 비슷하게 온라인 작업에 상당한 영향을 끼치기 때문이다.

묵시적 테이블 락은 MyISAM, Memory 테이블에 데이터를 변경하는 쿼리를 실행하면 발생한다. MySQL 서버가 데이터가 변경되는 테이블에 잠금을 설정하고, 데이터를 변경하면 즉시 잠금을 해제한다.
쿼리가 실행되는 동안 자동으로 획득하고, 자동으로 해제된다. 하지만 InnoDB는 레코드 기반의 잠금을 제공하기 때문에 묵시적 테이블 락이 설정되지 않는다. 정확히는 DDL 실행하는 경우에만 영향을 미친다.

### 네임드 락

네임드 락은 임의의 문자열에 대해 락을 설정할 수 있다. 특정 문자열에 대해 락을 설정하면, 해당 문자열을 사용하는 테이블에 대해 락을 설정한다.
자주 사용하진 않지만, 많은 레코드를 변경하는 트랜잭션에 유용하다. 배치 프로그램처럼 한번에 많은 레코드를 변경하는 쿼리에서 데드락을 최소화할 수 있다.

"mylockString" 문자열에 대해 잠금을 획득하고, 이미 시용 중이라면 10초를 대기하고, 잠금을 해제한다.
![스크린샷 2023-12-01 173126](https://github.com/sa46lll/real-mysql/assets/62706048/14fd3189-51d4-4137-a200-93bc2a2b004c)


### 메타데이터 락

메타데이터 락은 테이블이나 뷰의 이름이나 구조를 변경할 경우 발생한다. 'rename table A to B'와 같은 쿼리를 실행하면 자동으로 획득하고, 쿼리가 완료되면 자동으로 해제된다.
명시적으로는 사용할 수 없다. 
